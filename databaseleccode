const express = require('express');
const app = express();
const port = 3000;
const mongoose = require('mongoose');
const { boolean } = require('webidl-conversions');


app.use(express.json());
app.use(express.urlencoded({ extended: true }));

const url = 'mongodb://localhost:27017/hospitalDB';

//patient schema
const patient=new mongoose.Schema({
    patientId:String ,
    FirstName:String ,
    LastName:String ,
    Age:Number ,
    Gender:String ,
    Address:String ,
    PhoneNumber:String ,
    Email:String ,
    MedicalHistory:[String],
    date:{ type: Date, default: Date.now }
    
});
//Doctor schema
const doctor=new mongoose.Schema({
    doctorId:String ,
    FirstName:String ,
    LastName:String ,
    Age:Number ,
    Gender:String ,
    Address:String ,
    PhoneNumber:String ,
    Email:String ,
    Specialization:String ,
    dateOFJoining:{ type: Date, default: Date.now },
    department:String
});

//appointment schema
const appointment=new mongoose.Schema({
    appointmentId:String ,
    patientId:String ,
doctorId:String ,
    appointmentDate:Date ,
    reasonForVisit:String ,
    status:String ,
    date:{ type: Date, default: Date.now },
    room:String
});
//medical record schema
const medicalRecord=new mongoose.Schema({
    recordId:String ,
    patientId:String ,
    doctorId:String ,
    diagnosis:String ,
    treatment:String ,
    prescriptions:[String],
   visitdate:{ type: Date, default: Date.now }
   ,medications:[String]
});
//department schema
const department=new mongoose.Schema({
    departmentId:String ,
    name:String ,
    location:String ,
    headOfDepartment:String ,
    contactNumber:String ,
    date:{ type: Date, default: Date.now },
    doctorID:String,
    PhoneNumber:String,
    isActive:Boolean
});

//medication schema
const Medications = new mongoose.Schema({
    medicationId: String,
    name: String,
    type: String,
    strength: String,
    description: String,
    category: String,
    sideeffect: [String],
    isactive: Boolean,
    price: Number,
    unitprice: String,
});

//laboratory schema
const Laboratory = new mongoose.Schema({
    patientid: String,
    doctorid: String,
    testtype: String,
    testcode: String,
    testname: String,
    orderdate: { type: Date, default: Date.now },
    collectdate: { type: Date, default: Date.now },
    statusresults: String,
    notes: String,
});

//billing schema
const Billing = new mongoose.Schema({
    patientid: String,
    billid: String,
    appointmentid: String,
    billdate: { type: Date, default: Date.now },
    price: Number,
    category: String,
    description: String,
    tax: Number,
    totalamount: Number,
    paymentmethod: String
});

//staff schema
const staff = new mongoose.Schema({
    staffId: String,
    firstName: String,
    lastName: String,
    dateOfBirth: Date,
    gender: String,
    department: String,
    employeeType: String,
    Phone: String,
    email: String,
    hiredate: Date,
    salary: String
});

//collection schema
const collection = new mongoose.Schema({
    itemid: String,
    category: String,
    name: String,
    description: String,
    purchaseDate: Date,
    model: String,
    location: String,
    warrantyExpiry: Date,
    purchasePrice: String
});


const Patient = mongoose.model('Patient', patient);
const Doctor = mongoose.model('Doctor', doctor);
const Appointment = mongoose.model('Appointment', appointment);
const MedicalRecord = mongoose.model('MedicalRecord', medicalRecord);
const Department = mongoose.model('Department', department);

const Medication = mongoose.model('Medication', Medications);
const LabTest = mongoose.model('LabTest', Laboratory);
const Bill = mongoose.model('Bill', Billing);
const Staff = mongoose.model('Staff', staff);
const Collection = mongoose.model('Collection', collection);

//insertion
async function insertManyPatient() {
    try {
        const patients = [
            {
                 patientId:"P001" ,
    FirstName:"John" ,
    LastName:"Doe" ,
    Age:30 ,
    Gender:"Male" ,
    Address:"123 Main St, Cityville" ,
    PhoneNumber:"7080990" ,
    Email:"johndoe@gmail.com" ,
    MedicalHistory:["Diabetes", "Hypertension   "],
    date: new Date()


}
,{
  patientId:"P002" ,
    FirstName:"Jana" ,
    LastName:"Smith" ,
    Age:25 ,
    Gender:"Female" ,
    Address:"456 Oak Ave, Townsville" ,
    PhoneNumber:"809900" ,
    Email:"janadmith@gmail.com" ,
    MedicalHistory:["Asthma" ],
    date: new Date()
},
{
patientId:"P003" ,
    FirstName:"james" ,
    LastName:"white" ,
    Age:45 ,
    Gender:"Male" ,
    Address:"789 Pine Rd, Villageburg" ,
    PhoneNumber:"  909900" ,
    Email:"jmeswhite112@gmail.com" ,
    MedicalHistory:["Allergies", "Arthritis"],
    date: new Date()

}

];
await Patient.insertMany(patients);
}


catch(error){        console.error("Error inserting documents:", error);
    }   

}

async function insertManydoctors() {
   try{
const Doctors=[
    {
      doctorId:"D001" ,
    FirstName:"Emily" ,
    LastName:"Johnson" ,
    Age:40 ,
    Gender:"Female" ,
    Address:"321 Elm St, Metropolis" ,
    PhoneNumber:"707070" ,
    Email:"EmilyJohnson@gmail.com" ,
    Specialization:"Cardiology" ,
    dateOFJoining: new Date(),
    department:"Cardiology  "
   },
   {

  doctorId:"D002" ,
    FirstName:"Michael" ,
    LastName:"Brown" ,
    Age:50 ,
    Gender:"Male" ,
    Address:"654 Maple Ave, Gotham" ,
    PhoneNumber:"606060" ,
    Email:"Michael1s@gmail.com" ,
    Specialization:"Neurology" ,
    dateOFJoining: new Date(),
    department:"Neurology"

   }
,
{
doctorId:"D003" ,
    FirstName:"Sarah" ,
    LastName:"Davis" ,
    Age:35,
    Gender:"Female" ,
    Address:"987 Cedar Rd, Star City" ,
    PhoneNumber:"505050" ,
    Email:"SarahDavis12@gmail.com" ,
    Specialization:"Pediatrics" ,
    dateOFJoining: new Date(),
    department:"Pediatrics"
}
] ;   await Doctor.insertMany(Doctors);
        
        }catch(error){        console.error("Error inserting documents:", error);   }
}

async function insertMnyAppointment(){
try{
const Appointments= [
    {
      appointmentId:"A001" ,
    patientId:"P001" ,
doctorId:"D001" ,
    appointmentDate:new Date('2024-07-15T10:00:00') ,
    reasonForVisit:"Regular check-up" ,
    status:"Scheduled" ,
    date: new Date(),
    room:"101"   



},
{
 appointmentId:"A002" ,
    patientId:"P002" ,
doctorId:"D002" ,
    appointmentDate:new Date('2024-07-16T14:30:00') ,
    reasonForVisit:"Headache and dizziness" ,
    status:"Completed" ,
    date: new Date(),
    room:"202"



},
{
     appointmentId:"A003" ,
    patientId:"P003" ,
doctorId:"D003" ,
    appointmentDate:new Date('2024-07-17T09:15:00') ,
    reasonForVisit:"Child wellness exam" ,
    status:"Cancelled" ,
    date: new Date(),
    room:"303"
}

];
  await Appointment.insertMany(Appointments);
}catch(error){        console.error("Error inserting documents:", error);   }   


}

async function insertManyMedicalRecord(){
try{
const MedicalRecords=[{
 recordId:"MR001" ,
    patientId:"P001" ,
    doctorId:"D001" ,
    diagnosis:"Type 2 Diabetes" ,
    treatment:"Metformin 500mg daily" ,
    prescriptions:["Metformin", "Insulin"],
   visitdate: new Date()
   ,medications:["Metformin", "Insulin"]




},{
     recordId:"MR002" ,
    patientId:"P002" ,
    doctorId:"D002" ,
    diagnosis:"Chronic Migraine" ,
    treatment:"Topiramate 25mg daily" ,
    prescriptions:["Topiramate", "Sumatriptan"],
   visitdate: new Date()
   ,medications:["Topiramate", "Sumatriptan"]
},{
 recordId:"MR003" ,
    patientId:"P003" ,
    doctorId:"D003" ,
    diagnosis:"Asthma" ,
    treatment:  "Inhaled corticosteroids" ,
    prescriptions:["Inhaled corticosteroids", "Albuterol"],
   visitdate: new Date()
   ,medications:["Inhaled corticosteroids", "Albuterol"]

}]
;
  await MedicalRecord.insertMany(MedicalRecords);

}
catch(error){        console.error("Error inserting documents:", error);   }    





}




async function insertManydepartment(){
try{
const Departments=[{
    departmentId:"DEP001" ,
    name:"Cardiology" ,
    location:"Building A, 2nd Floor" ,
    headOfDepartment:"Dr. Emily Johnson" ,
    contactNumber:"123-456-7890" ,
   date: new Date(),
    doctorID:"D001",
    PhoneNumber:"707070",
    isActive:true
},{
    departmentId:"DEP002" ,
    name:"Neurology" ,
    location:"Building B, 3rd Floor" ,
    headOfDepartment:"Dr. Michael Brown" ,
    contactNumber:"234-567-8901" ,
   date: new Date(),
    doctorID:"D002",
    PhoneNumber:"606060",
    isActive:true
},{
    departmentId:"DEP003" ,
    name:"Pediatrics" ,
    location:"Building C, 1st Floor" ,
    headOfDepartment:"Dr. Sarah Davis" ,
    contactNumber:"345-678-9012" ,
date: new Date(),
    doctorID:"D003",
    PhoneNumber:"   505050",
    isActive:true
}]
;
const result = await Department.insertMany(Departments);
        console.log(" Departments inserted successfully:", result.length);

}
catch(error){        console.error("Error inserting documents:", error);   }
}

async function updatePatient(patientId){

try{
    await Patient.findOneAndUpdate(
        { patientId: patientId },{$set: { Address: "New york city" ,phoneNumber:"804055"}});
    await Patient.findOneAndUpdate(
       { patientId: patientId },{$set: { Address: "Los angeles" ,phoneNumber:"705055"}});
    await Patient.findOneAndUpdate(
        { patientId: patientId },{$set: { Address: "Chicago" ,phoneNumber:"809955"}});
    console.log('Patient address updated successfully.');
}catch(error){
    console.error('Error updating patient address:', error);}


}
async function findByIdAndUpdate(departmentId){
try{
    await Department.findOneAndUpdate(
 { departmentId: departmentId },{$set: { location: "Building D, 4th Floor" ,contactNumber:"456-789-0123"}});
    await Department.findOneAndUpdate(
{ departmentId: departmentId },{$set: { location: "Building E, 5th Floor" ,contactNumber:"567-890-1234"}});
    await Department.findOneAndUpdate(
{ departmentId: departmentId },{$set: { location: "Building F, 6th Floor" ,contactNumber:"678-901-2345"}});

}
catch(error){
    console.error('Error updating document:', error);}
}

async function findByIdAndUpdateDepartment(departmentId){
try{
    await Department.findOneAndUpdate(
{ departmentId: departmentId },{$set: { headOfDepartment: "Dr. Alice Williams" ,isActive:false}});
    await Department.findOneAndUpdate(
{ departmentId: departmentId },{$set: { headOfDepartment: "Dr. Robert Miller" ,isActive:false}});
    await Department.findOneAndUpdate(
{ departmentId: departmentId },{$set: { headOfDepartment: "Dr. Linda Wilson" ,isActive:false}}


    );

    }catch(error){
    console.error('Error updating document:', error);}  }

async function findByIdAndUpdateAppointment(appointmentId){
try{
    await Appointment.findOneAndUpdate(
 { appointmentId: appointmentId },{$set: { status: "Completed" ,room:"404"}});
    await Appointment.findOneAndUpdate(
 { appointmentId: appointmentId },{$set: { status: "Cancelled" ,room:"505"}});
    await Appointment.findOneAndUpdate(
 { appointmentId: appointmentId },{$set: { status: "Scheduled" ,room:"606"}});
    }catch(error){console.log("error");}}

async function findbyidandreadpat(patientId){
const found =await Patient.findOne({ patientId: patientId });
try{
    if(!found){
        console.log("not found");
    }else{
        console.log("The patient is :",found);
    }
} catch(error){console.log("error");}


}

async function findbyidandreaddoc(doctorId){
const found =await Doctor.findOne({ doctorId: doctorId });
const f1 =await Doctor.findOne({ doctorId: doctorId });
try{
    if(!found||!f1){
        console.log("not found");
    }else{
        console.log("The Doctor is :",found);
        console.log("The Doctor is :",f1);
    }
} catch(error){console.log("error");}


}

async function findbyidandreaddep(departmentId){
const found =await Department.findOne({ departmentId: departmentId });
const f1 =await Department.findOne({ departmentId: departmentId });
try{
    if(!found||!f1){
        console.log("not found");
    }else{
        console.log("The department is :",found);
        console.log("The department is :",f1);
    }
} catch(error){console.log("error");}


}

async function findbyidandreadapp(appointmentId){
const found =await Appointment.findOne({ appointmentId: appointmentId });
const f1 =await Appointment.findOne({ appointmentId: appointmentId });
try{
    if(!found||!f1){
        console.log("not found");
    }else{
        console.log("The appoinment is :",found);
        console.log("The appoinment is :",f1);
    }
} catch(error){console.log("error");}


}


async function findbyidandreadmed(recordId){
const found =await MedicalRecord.findOne({ recordId: recordId });
const f1 =await MedicalRecord.findOne({ recordId: recordId });
try{
    if(!found||!f1){
        console.log("not found");
    }else{
        console.log("The medical record is :",found);
        console.log("The medical record is :",f1);
    }
} catch(error){console.log("error");}
}

async function deletebyidpatient(patientId){
try{
    await Patient.findOneAndDelete({ patientId: patientId });
    console.log("Patient deleted successfully");
}catch(error){console.log("error deleting patient");}   
}
async function deletebyiddoctor(doctorId){
try{
    await Doctor.findOneAndDelete({doctorId:doctorId});
    console.log("Doctor deleted successfully");
}catch(error){console.log("error deleting doctor");}
}

async function insertManyMedication() {
    try {
        const medications = [
            {
                medicationId: "M001",
                name: "Aspirin",
                type: "Tablet",
                strength: "100mg",
                description: "Pain reliever",
                category: "Analgesic",
                sideeffect: ["Stomach upset", "Bleeding"],
                isactive: true,
                price: 5.99,
                unitprice: "per tablet"
            },
            {
                medicationId: "M002",
                name: "Ibuprofen",
                type: "Tablet",
                strength: "200mg",
                description: "Anti-inflammatory",
                category: "NSAID",
                sideeffect: ["Nausea", "Dizziness"],
                isactive: true,
                price: 7.49,
                unitprice: "per tablet"
            },
            {
                medicationId: "M003",
                name: "Paracetamol",
                type: "Tablet",
                strength: "500mg",
                description: "Fever reducer",
                category: "Analgesic",
                sideeffect: ["Liver damage"],
                isactive: true,
                price: 4.99,
                unitprice: "per tablet"
            }
        ];
        await Medication.insertMany(medications);
        console.log("Medications inserted successfully");
    } catch (error) {
        console.error("Error inserting medications:", error);
    }
}

async function updateMedication(medicationId) {
    try {
        await Medication.findOneAndUpdate(
            { medicationId: medicationId },
            { $set: { price: 6.99, isactive: false } }
        );
        console.log('Medication updated successfully.');
    } catch (error) {
        console.error('Error updating medication:', error);
    }
}

async function findbyidandreadmedication(medicationId) {
    try {
        const found = await Medication.findOne({ medicationId: medicationId });
        if (!found) {
            console.log("Medication not found");
        } else {
            console.log("The medication is:", found);
        }
    } catch (error) {
        console.log("Error reading medication:", error);
    }
}

// Staff functions
async function insertManyStaff() {
    try {
        const staffs = [
            {
                staffId: "S001",
                firstName: "John",
                lastName: "Doe",
                dateOfBirth: new Date('1985-05-15'),
                gender: "Male",
                department: "Nursing",
                employeeType: "Nurse",
                Phone: "123-456-7890",
                email: "john.doe@hospital.com",
                hiredate: new Date('2010-01-01'),
                salary: "50000"
            },
            {
                staffId: "S002",
                firstName: "Jane",
                lastName: "Smith",
                dateOfBirth: new Date('1990-08-20'),
                gender: "Female",
                department: "Administration",
                employeeType: "Admin",
                Phone: "234-567-8901",
                email: "jane.smith@hospital.com",
                hiredate: new Date('2015-03-15'),
                salary: "45000"
            },
            {
                staffId: "S003",
                firstName: "Mike",
                lastName: "Johnson",
                dateOfBirth: new Date('1980-12-10'),
                gender: "Male",
                department: "IT",
                employeeType: "Technician",
                Phone: "345-678-9012",
                email: "mike.johnson@hospital.com",
                hiredate: new Date('2008-07-20'),
                salary: "55000"
            }
        ];
        await Staff.insertMany(staffs);
        console.log("Staff inserted successfully");
    } catch (error) {
        console.error("Error inserting staff:", error);
    }
}

async function updateStaff(staffId) {
    try {
        await Staff.findOneAndUpdate(
            { staffId: staffId },
            { $set: { salary: "60000", department: "HR" } }
        );
        console.log('Staff updated successfully.');
    } catch (error) {
        console.error('Error updating staff:', error);
    }
}

async function findbyidandreadstaff(staffId) {
    try {
        const found = await Staff.findOne({ staffId: staffId });
        if (!found) {
            console.log("Staff not found");
        } else {
            console.log("The staff is:", found);
        }
    } catch (error) {
        console.log("Error reading staff:", error);
    }
}

// Collection functions
async function insertManyCollection() {
    try {
        const collections = [
            {
                itemid: "C001",
                category: "Equipment",
                name: "X-Ray Machine",
                description: "Medical imaging device",
                purchaseDate: new Date('2020-01-15'),
                model: "XR-100",
                location: "Radiology Room",
                warrantyExpiry: new Date('2025-01-15'),
                purchasePrice: "50000"
            },
            {
                itemid: "C002",
                category: "Furniture",
                name: "Hospital Bed",
                description: "Adjustable patient bed",
                purchaseDate: new Date('2019-06-10'),
                model: "HB-200",
                location: "Ward A",
                warrantyExpiry: new Date('2024-06-10'),
                purchasePrice: "2000"
            },
            {
                itemid: "C003",
                category: "Supplies",
                name: "Syringe Set",
                description: "Disposable syringes",
                purchaseDate: new Date('2023-03-05'),
                model: "SS-50",
                location: "Storage Room",
                warrantyExpiry: new Date('2024-03-05'),
                purchasePrice: "100"
            }
        ];
        await Collection.insertMany(collections);
        console.log("Collections inserted successfully");
    } catch (error) {
        console.error("Error inserting collections:", error);
    }
}

async function updateCollection(itemid) {
    try {
        await Collection.findOneAndUpdate(
            { itemid: itemid },
            { $set: { location: "New Location", purchasePrice: "60000" } }
        );
        console.log('Collection updated successfully.');
    } catch (error) {
        console.error('Error updating collection:', error);
    }
}

async function findbyidandreadcollection(itemid) {
    try {
        const found = await Collection.findOne({ itemid: itemid });
        if (!found) {
            console.log("Collection item not found");
        } else {
            console.log("The collection item is:", found);
        }
    } catch (error) {
        console.log("Error reading collection:", error);
    }
}

// Laboratory (LabTest) functions
async function insertManyLabTest() {
    try {
        const labTests = [
            {
                patientid: "P001",
                doctorid: "D001",
                testtype: "Blood Test",
                testcode: "BT001",
                testname: "Complete Blood Count",
                orderdate: new Date(),
                collectdate: new Date(),
                statusresults: "Pending",
                notes: "Routine check"
            },
            {
                patientid: "P002",
                doctorid: "D002",
                testtype: "Urine Test",
                testcode: "UT001",
                testname: "Urinalysis",
                orderdate: new Date(),
                collectdate: new Date(),
                statusresults: "Completed",
                notes: "Normal results"
            },
            {
                patientid: "P003",
                doctorid: "D003",
                testtype: "X-Ray",
                testcode: "XR001",
                testname: "Chest X-Ray",
                orderdate: new Date(),
                collectdate: new Date(),
                statusresults: "In Progress",
                notes: "Follow-up required"
            }
        ];
        await LabTest.insertMany(labTests);
        console.log("Lab tests inserted successfully");
    } catch (error) {
        console.error("Error inserting lab tests:", error);
    }
}

async function updateLabTest(testcode) {
    try {
        await LabTest.findOneAndUpdate(
            { testcode: testcode },
            { $set: { statusresults: "Completed", notes: "Updated notes" } }
        );
        console.log('Lab test updated successfully.');
    } catch (error) {
        console.error('Error updating lab test:', error);
    }
}

async function findbyidandreadlabtest(testcode) {
    try {
        const found = await LabTest.findOne({ testcode: testcode });
        if (!found) {
            console.log("Lab test not found");
        } else {
            console.log("The lab test is:", found);
        }
    } catch (error) {
        console.log("Error reading lab test:", error);
    }
}

// Billing functions
async function insertManyBill() {
    try {
        const bills = [
            {
                patientid: "P001",
                billid: "B001",
                appointmentid: "A001",
                billdate: new Date(),
                price: 100,
                category: "Consultation",
                description: "Doctor visit",
                tax: 10,
                totalamount: 110,
                paymentmethod: "Cash"
            },
            {
                patientid: "P002",
                billid: "B002",
                appointmentid: "A002",
                billdate: new Date(),
                price: 150,
                category: "Treatment",
                description: "Medication",
                tax: 15,
                totalamount: 165,
                paymentmethod: "Credit Card"
            },
            {
                patientid: "P003",
                billid: "B003",
                appointmentid: "A003",
                billdate: new Date(),
                price: 200,
                category: "Surgery",
                description: "Minor surgery",
                tax: 20,
                totalamount: 220,
                paymentmethod: "Insurance"
            }
        ];
        await Bill.insertMany(bills);
        console.log("Bills inserted successfully");
    } catch (error) {
        console.error("Error inserting bills:", error);
    }
}

async function updateBill(billid) {
    try {
        await Bill.findOneAndUpdate(
            { billid: billid },
            { $set: { totalamount: 120, paymentmethod: "Online" } }
        );
        console.log('Bill updated successfully.');
    } catch (error) {
        console.error('Error updating bill:', error);
    }
}

async function findbyidandreadbill(billid) {
    try {
        const found = await Bill.findOne({ billid: billid });
        if (!found) {
            console.log("Bill not found");
        } else {
            console.log("The bill is:", found);
        }
    } catch (error) {
        console.log("Error reading bill:", error);
    }
}










app.get('/', (req, res) => {
    res.send('Welcome to the Express App with MongoDB!');
});





const connectDB = async () => {
    try {
        await mongoose.connect(url);
        console.log('MongoDB connection successful!');

        app.listen(port, () => {
            console.log(` Server running on port ${port}`);
        });
      await insertManyPatient();
        await insertManydoctors();
        await insertMnyAppointment();
        await insertManyMedicalRecord();
        await insertManydepartment();
        await insertManyMedication();
        await insertManyStaff();
        await insertManyCollection();
        await insertManyLabTest();
        await insertManyBill();

        console.log("All data inserted successfully!");


        await updatePatient("P001");
        await findByIdAndUpdateDepartment("DEP001");
        await findByIdAndUpdateAppointment("A001");
        await updateMedication("M001");
        await updateStaff("S001");
        await updateCollection("C001");
        await updateLabTest("BT001");
        await updateBill("B001");
        await findbyidandreadpat("P001");
        await findbyidandreaddoc("D001");
        await findbyidandreaddep("DEP001");
        await findbyidandreadapp("A001");
        await findbyidandreadmedication("M001");
        await findbyidandreadstaff("S001");
        await findbyidandreadcollection("C001");
        await findbyidandreadlabtest("BT001");
        await findbyidandreadbill("B001");

        await findbyidandreadmed("MR001");
              console.log("Testing deletion...");
        await deletebyidpatient("P003");
        await deletebyiddoctor("D001");
    } catch (err) {
        console.error('MongoDB connection error:', err.message);
        process.exit(1);
    }
};

connectDB();
